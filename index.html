<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Production Tracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 15px;
    }

    .header-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .datetime {
      background: rgba(255, 255, 255, 0.2);
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: 600;
    }

    .nav-links {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .nav-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .nav-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .controls {
      background: #f8f9fa;
      padding: 20px 30px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .status-indicator {
      background: linear-gradient(135deg, #00d2ff, #3a7bd5);
      color: white;
      padding: 12px 25px;
      border-radius: 25px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
    }

    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .main-content {
      padding: 30px;
    }

    .add-channel-section {
      background: #f8f9fa;
      border-radius: 15px;
      margin-bottom: 30px;
      overflow: hidden;
    }

    .form-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 18px;
    }

    .form-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }

    .form-content.open {
      max-height: 500px;
      padding: 30px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
      border: none;
      padding: 15px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }

    .table-container {
      background: white;
      border-radius: 15px;
      overflow-x: auto;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px 15px;
      text-align: left;
      font-weight: 600;
      font-size: 16px;
    }

    td {
      padding: 20px 15px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }

    tr:nth-child(even) {
      background: #f8f9fa;
    }

    tr:hover {
      background: #e3f2fd;
    }

    .channel-name {
      font-weight: 600;
      color: #2c3e50;
    }

    .health-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
      text-transform: uppercase;
    }

    .health-good {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
    }

    .health-issue {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
      color: white;
    }

    .complete-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .complete-btn.completed {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
    }

    .delete-btn {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .action-btn:hover {
      transform: translateY(-2px);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 400px;
    }

    .modal-icon {
      width: 80px;
      height: 80px;
      background: #27ae60;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 40px;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      margin-top: 20px;
      font-weight: 600;
    }

    .debug-info {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: #0f0;
      padding: 10px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 12px;
      max-width: 300px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>🎥 Video Production Tracker</h1>
      <div class="header-info">
        <div class="datetime" id="datetime">Loading...</div>
        <nav class="nav-links">
          <a href="#" class="nav-btn">📋 Manager Task</a>
          <a href="#" class="nav-btn">📊 Channel Status</a>
          <a href="#" class="nav-btn">💰 Payment</a>
        </nav>
      </div>
    </header>

    <div class="controls">
      <div class="status-indicator" id="statusIndicator">
        <span>🟢</span>
        <span>Connected</span>
      </div>
      <button class="control-btn" id="resetBtn">
        🔄 Reset All to Pending
      </button>
    </div>

    <main class="main-content">
      <section class="add-channel-section">
        <div class="form-header" id="formHeader">
          <span>➕ Add New Channel</span>
          <span id="formToggleIcon">▼</span>
        </div>
        <div class="form-content" id="addChannelForm">
          <div class="form-grid">
            <input type="text" id="channelId" placeholder="Channel ID" class="form-input">
            <input type="text" id="channelName" placeholder="Channel Name" class="form-input">
            <input type="text" id="clientName" placeholder="Client Name" class="form-input">
            <input type="text" id="collaboratorName" placeholder="Collaborator" class="form-input">
            <input type="number" id="videosPerMonth" placeholder="Videos Per Month" class="form-input" min="0">
          </div>
          <button class="submit-btn" id="submitBtn">Create Channel</button>
        </div>
      </section>

      <section class="table-container">
        <table>
          <thead>
            <tr>
              <th>Channel</th>
              <th>Client</th>
              <th>Collaborator</th>
              <th>Videos/Month</th>
              <th>Health</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="channelsTableBody">
            <tr>
              <td colspan="7" class="empty-state">
                <h3>Loading channels...</h3>
                <p>Please wait while we fetch your data</p>
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>

    <div class="modal" id="successModal">
      <div class="modal-content">
        <div class="modal-icon">✓</div>
        <div style="font-size: 24px; margin-bottom: 15px; font-weight: 600;">Great Job!</div>
        <div>Channel completed successfully!</div>
        <button class="modal-close" id="modalCloseBtn">Continue</button>
      </div>
    </div>
  </div>

  <div class="debug-info" id="debugInfo">Console: Open F12</div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    console.log('Script loaded successfully');

    const supabase = createClient(
      'https://prkrbswttmtgeplsvzlj.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBya3Jic3d0dG10Z2VwbHN2emxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTk5NjQsImV4cCI6MjA3MjYzNTk2NH0.Ul2cd-cpWHfpK1HTgHM7Tv2NDCrFWcAq2N-C7Tv9oz8'
    );

    console.log('Supabase client initialized');

    let channels = [];

    function initApp() {
      console.log('Initializing app...');
      updateDateTime();
      setInterval(updateDateTime, 1000);
      loadChannels();
      setupEventListeners();
    }

    function setupEventListeners() {
      console.log('Setting up event listeners...');
      
      document.getElementById('formHeader').addEventListener('click', toggleAddForm);
      document.getElementById('submitBtn').addEventListener('click', addNewChannel);
      document.getElementById('resetBtn').addEventListener('click', resetAllChannels);
      document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
      
      console.log('Event listeners attached');
    }

    function updateDateTime() {
      const now = new Date();
      document.getElementById('datetime').textContent = now.toLocaleString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    async function loadChannels() {
      try {
        console.log('Loading channels from database...');
        updateStatus('🔄 Loading...', '#ffc107');
        
        const { data, error } = await supabase
          .from('tasks')
          .select('*')
          .order('created_at', { ascending: false });

        console.log('Database response:', { data, error });

        if (error) {
          console.error('Database error:', error);
          throw error;
        }

        channels = data || [];
        console.log(`Loaded ${channels.length} channels`);
        renderChannelsTable();
        updateStatus('🟢 Connected', '#28a745');

      } catch (error) {
        console.error('Error loading channels:', error);
        updateStatus('🔴 Error', '#dc3545');
        alert('Failed to load channels. Error: ' + error.message);
      }
    }

    function renderChannelsTable() {
      console.log('Rendering table with', channels.length, 'channels');
      const tbody = document.getElementById('channelsTableBody');
      
      if (channels.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <h3>No channels found</h3>
              <p>Add your first channel using the form above</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = channels.map(channel => `
        <tr>
          <td><div class="channel-name">${channel.channel || 'N/A'}</div></td>
          <td>${channel.client || 'Not specified'}</td>
          <td>${channel.collaborator || 'Unassigned'}</td>
          <td>${channel.daily_videos || 0}</td>
          <td>
            <button class="health-btn health-${channel.health || 'good'}" data-action="toggle-health" data-id="${channel.id}">
              ${channel.health === 'issue' ? '⚠ Issue' : '✓ Good'}
            </button>
          </td>
          <td>
            <span class="status-badge status-${channel.status || 'pending'}">
              ${channel.status || 'pending'}
            </span>
          </td>
          <td>
            <div class="actions">
              <button class="action-btn complete-btn ${channel.status === 'completed' ? 'completed' : ''}" 
                      data-action="toggle-status" data-id="${channel.id}">
                ${channel.status === 'completed' ? 'Completed' : 'Complete'}
              </button>
              <button class="action-btn delete-btn" data-action="delete" data-id="${channel.id}">
                Delete
              </button>
            </div>
          </td>
        </tr>
      `).join('');

      attachTableEventListeners();
    }

    function attachTableEventListeners() {
      console.log('Attaching table button listeners...');
      
      document.querySelectorAll('[data-action]').forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const action = this.getAttribute('data-action');
          const id = this.getAttribute('data-id');
          
          console.log('Button clicked:', action, id);
          
          if (action === 'toggle-health') {
            toggleHealth(id);
          } else if (action === 'toggle-status') {
            toggleChannelStatus(id);
          } else if (action === 'delete') {
            deleteChannel(id);
          }
        });
      });
    }

    function updateStatus(text, color) {
      const indicator = document.getElementById('statusIndicator');
      indicator.innerHTML = `<span style="color: ${color}">●</span><span>${text}</span>`;
    }

    function toggleAddForm() {
      console.log('Toggle form clicked');
      const form = document.getElementById('addChannelForm');
      const icon = document.getElementById('formToggleIcon');
      
      if (form.classList.contains('open')) {
        form.classList.remove('open');
        icon.textContent = '▼';
      } else {
        form.classList.add('open');
        icon.textContent = '▲';
      }
    }

    async function addNewChannel() {
      console.log('Add channel clicked');
      const id = document.getElementById('channelId').value.trim();
      const name = document.getElementById('channelName').value.trim();
      const client = document.getElementById('clientName').value.trim();
      const collaborator = document.getElementById('collaboratorName').value.trim();
      const videosPerMonth = parseInt(document.getElementById('videosPerMonth').value) || 0;

      console.log('Form values:', { id, name, client, collaborator, videosPerMonth });

      if (!id || !name) {
        alert('Channel ID and Name are required');
        return;
      }

      try {
        updateStatus('🔄 Adding...', '#ffc107');

        const newChannel = {
          id,
          channel: name,
          client: client || null,
          collaborator: collaborator || null,
          daily_videos: videosPerMonth,
          status: 'pending',
          health: 'good',
          last_updated: new Date().toISOString(),
          created_at: new Date().toISOString()
        };

        console.log('Inserting channel:', newChannel);

        const { error } = await supabase.from('tasks').insert([newChannel]);

        if (error) {
          console.error('Insert error:', error);
          throw error;
        }

        document.getElementById('channelId').value = '';
        document.getElementById('channelName').value = '';
        document.getElementById('clientName').value = '';
        document.getElementById('collaboratorName').value = '';
        document.getElementById('videosPerMonth').value = '';
        
        toggleAddForm();
        loadChannels();
        alert('✅ Channel added successfully!');

      } catch (error) {
        console.error('Error adding channel:', error);
        updateStatus('🔴 Error', '#dc3545');
        alert(error.code === '23505' ? 'Channel ID already exists' : 'Failed to add channel: ' + error.message);
      }
    }

    async function toggleHealth(channelId) {
      console.log('Toggle health for:', channelId);
      try {
        const channel = channels.find(c => c.id === channelId);
        if (!channel) {
          console.error('Channel not found:', channelId);
          return;
        }

        const newHealth = channel.health === 'good' ? 'issue' : 'good';
        console.log('Updating health to:', newHealth);

        const { error } = await supabase
          .from('tasks')
          .update({ health: newHealth, last_updated: new Date().toISOString() })
          .eq('id', channelId);

        if (error) throw error;
        loadChannels();
        
      } catch (error) {
        console.error('Error updating health:', error);
        alert('Failed to update health status: ' + error.message);
      }
    }

    async function toggleChannelStatus(channelId) {
      console.log('Toggle status for:', channelId);
      try {
        const channel = channels.find(c => c.id === channelId);
        if (!channel) {
          console.error('Channel not found:', channelId);
          return;
        }

        const newStatus = channel.status === 'completed' ? 'pending' : 'completed';
        console.log('Updating status to:', newStatus);

        const { error } = await supabase
          .from('tasks')
          .update({ status: newStatus, last_updated: new Date().toISOString() })
          .eq('id', channelId);

        if (error) throw error;
        loadChannels();

        if (newStatus === 'completed') {
          document.getElementById('successModal').classList.add('show');
          setTimeout(() => closeModal(), 3000);
        }

      } catch (error) {
        console.error('Error updating status:', error);
        alert('Failed to update status: ' + error.message);
      }
    }

    async function deleteChannel(channelId) {
      console.log('Delete channel:', channelId);
      if (!confirm('Are you sure you want to delete this channel?')) return;

      try {
        const { error } = await supabase.from('tasks').delete().eq('id', channelId);
        if (error) throw error;
        loadChannels();
        alert('✅ Channel deleted successfully!');

      } catch (error) {
        console.error('Error deleting channel:', error);
        alert('Failed to delete channel: ' + error.message);
      }
    }

    async function resetAllChannels() {
      console.log('Reset all channels clicked');
      if (!confirm('Are you sure you want to reset all channels to pending?')) return;

      try {
        const { error } = await supabase
          .from('tasks')
          .update({ status: 'pending', last_updated: new Date().toISOString() })
          .eq('status', 'completed');

        if (error) throw error;
        loadChannels();
        alert('✅ All channels reset to pending!');

      } catch (error) {
        console.error('Error resetting channels:', error);
        alert('Failed to reset channels: ' + error.message);
      }
    }

    function closeModal() {
      console.log('Close modal clicked');
      document.getElementById('successModal').classList.remove('show');
    }

    initApp();
  </script>
</body>
</html>
