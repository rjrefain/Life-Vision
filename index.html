<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Production Tracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1500px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.8rem;
      margin-bottom: 15px;
      font-weight: 700;
    }

    .header-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 25px;
    }

    .datetime-display {
      background: rgba(255, 255, 255, 0.2);
      padding: 12px 25px;
      border-radius: 25px;
      font-weight: 600;
      font-size: 16px;
      backdrop-filter: blur(10px);
    }

    .nav-links {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .nav-button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      backdrop-filter: blur(10px);
    }

    .nav-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      border-color: rgba(255, 255, 255, 0.5);
    }

    /* Controls Bar */
    .controls-bar {
      background: #f8f9fa;
      padding: 25px 30px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 25px;
      flex-wrap: wrap;
    }

    .connection-status {
      background: linear-gradient(135deg, #00d2ff, #3a7bd5);
      color: white;
      padding: 12px 25px;
      border-radius: 25px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
    }

    .control-button {
      padding: 12px 25px;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 15px;
      position: relative;
    }

    .reset-button {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
    }

    .reorder-button {
      background: linear-gradient(135deg, #a8e6cf, #56ab2f);
      color: white;
    }

    .control-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .control-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }

    /* Reorder Dropdown */
    .reorder-wrapper {
      position: relative;
    }

    .reorder-menu {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      min-width: 220px;
      margin-top: 10px;
      display: none;
      z-index: 2000;
      border: 1px solid #e9ecef;
      overflow: hidden;
    }

    .reorder-menu.visible {
      display: block;
      animation: dropdownSlide 0.3s ease;
    }

    @keyframes dropdownSlide {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .menu-option {
      padding: 18px 25px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid #f0f0f0;
      font-weight: 500;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-option:last-child {
      border-bottom: none;
    }

    .menu-option:hover {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      color: #667eea;
      transform: translateX(5px);
    }

    /* Main Content */
    .main-section {
      padding: 35px;
    }

    /* Add Channel Form */
    .form-section {
      background: #f8f9fa;
      border-radius: 20px;
      margin-bottom: 35px;
      overflow: hidden;
      border: 1px solid #e9ecef;
    }

    .form-title {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px 25px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .form-title:hover {
      background: linear-gradient(135deg, #5a6fd8, #6a4190);
    }

    .form-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }

    .form-body.expanded {
      max-height: 600px;
      padding: 35px;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .form-field {
      width: 100%;
      padding: 18px 20px;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }

    .form-field:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .submit-button {
      width: 100%;
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
      border: none;
      padding: 18px 25px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 17px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .submit-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
    }

    /* Table Styles */
    .table-section {
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      border: 1px solid #e9ecef;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .table-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }

    .header-cell {
      padding: 25px 20px;
      text-align: left;
      font-weight: 600;
      font-size: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-cell:nth-child(4), 
    .header-cell:nth-child(5) {
      text-align: center;
    }

    .table-row {
      transition: all 0.2s ease;
    }

    .table-row:nth-child(even) {
      background: #f8f9fa;
    }

    .table-row:hover {
      background: #e3f2fd;
      transform: scale(1.01);
    }

    .table-cell {
      padding: 22px 20px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }

    .table-cell:nth-child(4), 
    .table-cell:nth-child(5) {
      text-align: center;
    }

    .channel-display {
      font-weight: 600;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .drag-indicator {
      color: #667eea;
      cursor: grab;
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }

    .drag-indicator:hover {
      opacity: 1;
    }

    /* Health Status */
    .health-toggle {
      padding: 10px 18px;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .health-good {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
    }

    .health-issue {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }

    .health-toggle:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    /* Status Badge */
    .status-indicator {
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
      border: 1px solid #a3d977;
    }

    /* Action Buttons */
    .action-group {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .action-button {
      padding: 10px 15px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 13px;
    }

    .edit-button {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .complete-button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 10px 18px;
    }

    .complete-button.completed {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
    }

    .delete-button {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    /* Edit Mode */
    .edit-field {
      width: 100%;
      max-width: 160px;
      padding: 10px 15px;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-size: 15px;
      background: white;
    }

    .edit-field:focus {
      outline: none;
      border-color: #764ba2;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .edit-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .save-button, .cancel-button {
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
    }

    .save-button {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
    }

    .cancel-button {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      color: white;
    }

    /* Success Modal */
    .success-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .success-modal.active {
      display: flex;
    }

    .modal-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 45px;
      border-radius: 25px;
      text-align: center;
      max-width: 420px;
      animation: modalAppear 0.4s ease;
    }

    @keyframes modalAppear {
      from {
        transform: scale(0.7);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modal-checkmark {
      width: 90px;
      height: 90px;
      background: #27ae60;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 25px;
      font-size: 45px;
    }

    .modal-heading {
      font-size: 28px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .modal-message {
      font-size: 18px;
      margin-bottom: 25px;
    }

    .modal-close-button {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
      padding: 15px 30px;
      border-radius: 25px;
      cursor: pointer;
      margin-top: 15px;
      font-weight: 600;
      font-size: 16px;
    }

    /* Empty State */
    .empty-display {
      text-align: center;
      padding: 80px 25px;
      color: #6c757d;
    }

    .empty-display h3 {
      font-size: 28px;
      margin-bottom: 15px;
      color: #495057;
    }

    .empty-display p {
      font-size: 18px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .header-info {
        flex-direction: column;
      }

      .controls-bar {
        flex-direction: column;
        gap: 20px;
      }

      .data-table, .table-header, tbody, .header-cell, .table-cell, .table-row {
        display: block;
      }

      .table-header .table-row {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }

      .table-row {
        border: 1px solid #ccc;
        border-radius: 15px;
        margin-bottom: 20px;
        padding: 20px;
        background: white;
      }

      .table-cell {
        border: none;
        padding: 12px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .table-cell::before {
        content: attr(data-mobile-label);
        font-weight: bold;
        color: #667eea;
        margin-right: 15px;
      }

      .action-group {
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header Section -->
    <header class="header">
      <h1>🎥 Video Production Tracker</h1>
      <div class="header-info">
        <div class="datetime-display" id="currentDateTime">Loading...</div>
        <nav class="nav-links">
          <a href="task-dashboard.html" class="nav-button">📋 Manager Tasks</a>
          <a href="channel-status-tracker.html" class="nav-button">📊 Channel Status</a>
          <a href="payment_tracker.html" class="nav-button">💰 Payments</a>
        </nav>
      </div>
    </header>

    <!-- Controls Bar -->
    <div class="controls-bar">
      <div class="connection-status" id="connectionStatus">
        <span>🟢</span>
        <span>Connected to Database</span>
      </div>
      
      <button class="control-button reset-button" onclick="resetAllChannels()" id="resetAllButton">
        🔄 Reset All to Pending
      </button>
      
      <!-- REORDER FUNCTIONALITY -->
      <div class="reorder-wrapper">
        <button class="control-button reorder-button" onclick="toggleReorderMenu()">
          📋 Auto Reorder ▼
        </button>
        <div class="reorder-menu" id="reorderMenu">
          <div class="menu-option" onclick="performReorder('collaborator')">
            👥 Sort by Collaborator
          </div>
          <div class="menu-option" onclick="performReorder('channel')">
            📁 Sort by Channel Name
          </div>
          <div class="menu-option" onclick="performReorder('client')">
            🏢 Sort by Client
          </div>
          <div class="menu-option" onclick="performReorder('videos')">
            📈 Sort by Videos/Month
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="main-section">
      <!-- Add Channel Form -->
      <section class="form-section">
        <div class="form-title" onclick="toggleAddChannelForm()">
          <span>➕ Add New Channel</span>
          <span id="formToggleArrow">▼</span>
        </div>
        <div class="form-body" id="addChannelFormBody">
          <div class="input-grid">
            <input type="text" id="newChannelId" placeholder="Channel ID" class="form-field" required>
            <input type="text" id="newChannelName" placeholder="Channel Name" class="form-field" required>
            <input type="text" id="newClientName" placeholder="Client Name" class="form-field">
            <input type="text" id="newCollaborator" placeholder="Collaborator Name" class="form-field">
            <input type="number" id="newVideosCount" placeholder="Videos Per Month" class="form-field" min="0">
          </div>
          <button class="submit-button" onclick="createNewChannel()">Create Channel</button>
        </div>
      </section>

      <!-- Channels Table -->
      <section class="table-section">
        <table class="data-table">
          <thead class="table-header">
            <tr class="table-row">
              <th class="header-cell">⋮⋮ Channel</th>
              <th class="header-cell">Client</th>
              <th class="header-cell">Collaborator</th>
              <th class="header-cell">Videos/Month</th>
              <th class="header-cell">Health Status</th>
              <th class="header-cell">Task Status</th>
              <th class="header-cell">Actions</th>
            </tr>
          </thead>
          <tbody id="channelsTable">
            <tr>
              <td colspan="7" class="empty-display">
                <h3>Loading channels...</h3>
                <p>Please wait while we fetch your video production data</p>
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
      <div class="modal-card">
        <div class="modal-checkmark">✓</div>
        <div class="modal-heading">Excellent Work!</div>
        <div class="modal-message">Channel task completed successfully!</div>
        <button class="modal-close-button" onclick="hideSuccessModal()">Continue Working</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2'

    // Initialize Supabase Client
    const supabaseClient = createClient(
      'https://prkrbswttmtgeplsvzlj.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBya3Jic3d0dG10Z2VwbHN2emxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTk5NjQsImV4cCI6MjA3MjYzNTk2NH0.Ul2cd-cpWHfpK1HTgHM7Tv2NDCrFWcAq2N-C7Tv9oz8'
    );

    // Application State
    let allChannels = [];
    let channelOrdering = [];
    let currentlyEditing = null;

    // Initialize Application
    function startApplication() {
      updateCurrentTime();
      setInterval(updateCurrentTime, 1000);
      loadAllChannels();
      
      // Close reorder menu when clicking outside
      document.addEventListener('click', (event) => {
        if (!event.target.closest('.reorder-wrapper')) {
          document.getElementById('reorderMenu').classList.remove('visible');
        }
      });
    }

    // Update Date and Time Display
    function updateCurrentTime() {
      const currentTime = new Date();
      const bangladeshTime = new Date(currentTime.toLocaleString('en-US', { timeZone: 'Asia/Dhaka' }));
      document.getElementById('currentDateTime').textContent = bangladeshTime.toLocaleString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    // Load All Channels from Database
    async function loadAllChannels() {
      try {
        updateConnectionStatus('🔄 Loading Data...', '#ffc107');
        
        // Load channels
        const { data: channelsData, error: channelsError } = await supabaseClient
          .from('tasks')
          .select('*');

        if (channelsError) throw channelsError;

        // Load channel ordering
        const { data: orderingData } = await supabaseClient
          .from('channel_order')
          .select('*')
          .order('order_position');

        allChannels = channelsData || [];
        channelOrdering = orderingData || [];
        
        displayChannelsTable();
        updateConnectionStatus('🟢 Connected to Database', '#28a745');

      } catch (error) {
        console.error('Database loading error:', error);
        updateConnectionStatus('🔴 Connection Error', '#dc3545');
        showErrorMessage('Failed to load channels from database');
      }
    }

    // Display Channels in Table
    function displayChannelsTable() {
      const tableBody = document.getElementById('channelsTable');
      
      if (allChannels.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-display">
              <h3>No Channels Found</h3>
              <p>Add your first video production channel using the form above</p>
            </td>
          </tr>
        `;
        return;
      }

      // Sort channels by custom order or creation date
      const sortedChannels = [...allChannels].sort((a, b) => {
        const orderA = channelOrdering.find(order => order.channel_id === a.id)?.order_position ?? 999;
        const orderB = channelOrdering.find(order => order.channel_id === b.id)?.order_position ?? 999;
        
        if (orderA !== orderB) {
          return orderA - orderB;
        }
        
        return new Date(b.created_at) - new Date(a.created_at);
      });

      tableBody.innerHTML = sortedChannels.map(channel => {
        const isInEditMode = currentlyEditing === channel.id;
        const healthStatus = channel.health || 'good';
        
        return `
          <tr class="table-row" data-channel-id="${channel.id}">
            <td class="table-cell" data-mobile-label="Channel">
              ${isInEditMode ? 
                `<input type="text" class="edit-field" id="edit-channel-${channel.id}" value="${channel.channel}">` :
                `<div class="channel-display">
                  <span class="drag-indicator">⋮⋮</span>
                  ${channel.channel}
                </div>`
              }
            </td>
            <td class="table-cell" data-mobile-label="Client">
              ${isInEditMode ? 
                `<input type="text" class="edit-field" id="edit-client-${channel.id}" value="${channel.client || ''}">` :
                (channel.client || 'Not specified')
              }
            </td>
            <td class="table-cell" data-mobile-label="Collaborator">
              ${isInEditMode ? 
                `<input type="text" class="edit-field" id="edit-collaborator-${channel.id}" value="${channel.collaborator || ''}">` :
                (channel.collaborator || 'Unassigned')
              }
            </td>
            <td class="table-cell" data-mobile-label="Videos/Month">
              ${isInEditMode ? 
                `<input type="number" class="edit-field" id="edit-videos-${channel.id}" value="${channel.daily_videos || 0}" min="0" style="max-width: 90px;">` :
                (channel.daily_videos || 0)
              }
            </td>
            <td class="table-cell" data-mobile-label="Health">
              <button class="health-toggle health-${healthStatus}" onclick="toggleHealthStatus('${channel.id}')">
                ${healthStatus === 'good' ? '✓ Good' : '⚠ Issue'}
              </button>
            </td>
            <td class="table-cell" data-mobile-label="Status">
              <span class="status-indicator status-${channel.status}">
                ${channel.status}
              </span>
            </td>
            <td class="table-cell" data-mobile-label="Actions">
              <div class="action-group">
                ${isInEditMode ? `
                  <div class="edit-controls">
                    <button class="action-button delete-button" onclick="removeChannel('${channel.id}')" title="Delete Channel">🗑️</button>
                `}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Update Connection Status Display
    function updateConnectionStatus(message, color) {
      const statusElement = document.getElementById('connectionStatus');
      statusElement.innerHTML = `<span style="color: ${color}">●</span><span>${message}</span>`;
    }

    // Show Error Message
    function showErrorMessage(message) {
      alert('❌ ' + message);
    }

    // Show Success Message
    function showSuccessMessage(message) {
      alert('✅ ' + message);
    }

    // Global Functions
    window.toggleAddChannelForm = function() {
      const formBody = document.getElementById('addChannelFormBody');
      const arrow = document.getElementById('formToggleArrow');
      
      if (formBody.classList.contains('expanded')) {
        formBody.classList.remove('expanded');
        arrow.textContent = '▼';
      } else {
        formBody.classList.add('expanded');
        arrow.textContent = '▲';
        setTimeout(() => document.getElementById('newChannelId').focus(), 300);
      }
    };

    window.createNewChannel = async function() {
      const channelId = document.getElementById('newChannelId').value.trim();
      const channelName = document.getElementById('newChannelName').value.trim();
      const clientName = document.getElementById('newClientName').value.trim();
      const collaborator = document.getElementById('newCollaborator').value.trim();
      const videosCount = parseInt(document.getElementById('newVideosCount').value) || 0;

      if (!channelId || !channelName) {
        showErrorMessage('Channel ID and Channel Name are required fields');
        return;
      }

      try {
        updateConnectionStatus('🔄 Creating Channel...', '#ffc107');

        const { error } = await supabaseClient.from('tasks').insert([{
          id: channelId,
          channel: channelName,
          client: clientName || null,
          collaborator: collaborator || null,
          daily_videos: videosCount,
          status: 'pending',
          health: 'good',
          last_updated: new Date().toISOString(),
          created_at: new Date().toISOString()
        }]);

        if (error) throw error;

        // Clear all form fields
        document.getElementById('newChannelId').value = '';
        document.getElementById('newChannelName').value = '';
        document.getElementById('newClientName').value = '';
        document.getElementById('newCollaborator').value = '';
        document.getElementById('newVideosCount').value = '';
        
        toggleAddChannelForm();
        loadAllChannels();
        showSuccessMessage('New channel created successfully!');

      } catch (error) {
        console.error('Channel creation error:', error);
        updateConnectionStatus('🔴 Creation Failed', '#dc3545');
        showErrorMessage(error.code === '23505' ? 'Channel ID already exists - please use a different ID' : 'Failed to create new channel');
      }
    };

    window.startChannelEdit = function(channelId) {
      if (currentlyEditing && currentlyEditing !== channelId) {
        cancelChannelEdit();
      }
      currentlyEditing = channelId;
      displayChannelsTable();
      
      setTimeout(() => {
        const firstInput = document.getElementById(`edit-channel-${channelId}`);
        if (firstInput) firstInput.focus();
      }, 100);
    };

    window.saveChannelChanges = async function(channelId) {
      try {
        const channelName = document.getElementById(`edit-channel-${channelId}`).value.trim();
        const clientName = document.getElementById(`edit-client-${channelId}`).value.trim();
        const collaborator = document.getElementById(`edit-collaborator-${channelId}`).value.trim();
        const videosCount = parseInt(document.getElementById(`edit-videos-${channelId}`).value) || 0;

        if (!channelName) {
          showErrorMessage('Channel name cannot be empty');
          return;
        }

        updateConnectionStatus('🔄 Saving Changes...', '#ffc107');

        const { error } = await supabaseClient
          .from('tasks')
          .update({
            channel: channelName,
            client: clientName || null,
            collaborator: collaborator || null,
            daily_videos: videosCount,
            last_updated: new Date().toISOString()
          })
          .eq('id', channelId);

        if (error) throw error;

        currentlyEditing = null;
        loadAllChannels();
        showSuccessMessage('Channel changes saved successfully!');

      } catch (error) {
        console.error('Save changes error:', error);
        updateConnectionStatus('🔴 Save Failed', '#dc3545');
        showErrorMessage('Failed to save channel changes');
      }
    };

    window.cancelChannelEdit = function() {
      currentlyEditing = null;
      displayChannelsTable();
    };

    window.toggleHealthStatus = async function(channelId) {
      try {
        const channel = allChannels.find(ch => ch.id === channelId);
        if (!channel) return;

        const currentHealth = channel.health || 'good';
        const newHealth = currentHealth === 'good' ? 'issue' : 'good';

        updateConnectionStatus('🔄 Updating Health...', '#ffc107');

        const { error } = await supabaseClient
          .from('tasks')
          .update({ 
            health: newHealth, 
            last_updated: new Date().toISOString() 
          })
          .eq('id', channelId);

        if (error) throw error;

        loadAllChannels();
        
      } catch (error) {
        console.error('Health status update error:', error);
        updateConnectionStatus('🔴 Update Failed', '#dc3545');
        showErrorMessage('Failed to update health status');
      }
    };

    window.toggleTaskStatus = async function(channelId) {
      try {
        const channel = allChannels.find(ch => ch.id === channelId);
        if (!channel) return;

        const newStatus = channel.status === 'completed' ? 'pending' : 'completed';

        updateConnectionStatus('🔄 Updating Status...', '#ffc107');

        const { error } = await supabaseClient
          .from('tasks')
          .update({ 
            status: newStatus, 
            last_updated: new Date().toISOString() 
          })
          .eq('id', channelId);

        if (error) throw error;

        loadAllChannels();

        if (newStatus === 'completed') {
          document.getElementById('successModal').classList.add('active');
          setTimeout(() => hideSuccessModal(), 4000);
        }

      } catch (error) {
        console.error('Task status update error:', error);
        updateConnectionStatus('🔴 Update Failed', '#dc3545');
        showErrorMessage('Failed to update task status');
      }
    };

    window.removeChannel = async function(channelId) {
      if (!confirm('Are you absolutely sure you want to delete this channel? This action cannot be undone.')) return;

      try {
        updateConnectionStatus('🔄 Deleting Channel...', '#ffc107');

        const { error } = await supabaseClient
          .from('tasks')
          .delete()
          .eq('id', channelId);

        if (error) throw error;

        // Also remove from channel ordering
        await supabaseClient.from('channel_order').delete().eq('channel_id', channelId);

        loadAllChannels();
        showSuccessMessage('Channel deleted successfully!');

      } catch (error) {
        console.error('Channel deletion error:', error);
        updateConnectionStatus('🔴 Deletion Failed', '#dc3545');
        showErrorMessage('Failed to delete channel');
      }
    };

    window.resetAllChannels = async function() {
      if (!confirm('Are you sure you want to reset ALL channels to pending status? This will affect all completed channels.')) return;

      const resetButton = document.getElementById('resetAllButton');
      resetButton.disabled = true;
      resetButton.textContent = '🔄 Resetting All...';

      try {
        updateConnectionStatus('🔄 Resetting All Channels...', '#ffc107');

        const { error } = await supabaseClient
          .from('tasks')
          .update({ 
            status: 'pending', 
            last_updated: new Date().toISOString() 
          })
          .eq('status', 'completed');

        if (error) throw error;

        loadAllChannels();
        showSuccessMessage('All channels have been reset to pending status!');

      } catch (error) {
        console.error('Reset all channels error:', error);
        updateConnectionStatus('🔴 Reset Failed', '#dc3545');
        showErrorMessage('Failed to reset all channels');
      } finally {
        resetButton.disabled = false;
        resetButton.textContent = '🔄 Reset All to Pending';
      }
    };

    // REORDER FUNCTIONALITY
    window.toggleReorderMenu = function() {
      document.getElementById('reorderMenu').classList.toggle('visible');
    };

    window.performReorder = async function(sortCriteria) {
      document.getElementById('reorderMenu').classList.remove('visible');
      
      try {
        updateConnectionStatus('🔄 Reordering Channels...', '#ffc107');

        // Get all channels for sorting
        const { data: channelsToSort, error } = await supabaseClient.from('tasks').select('*');
        if (error) throw error;

        let sortedChannelsList;
        
        switch(sortCriteria) {
          case 'collaborator':
            sortedChannelsList = channelsToSort.sort((a, b) => {
              const collabA = (a.collaborator || 'Unassigned').toLowerCase();
              const collabB = (b.collaborator || 'Unassigned').toLowerCase();
              return collabA === collabB 
                ? a.channel.toLowerCase().localeCompare(b.channel.toLowerCase())
                : collabA.localeCompare(collabB);
            });
            break;
          case 'channel':
            sortedChannelsList = channelsToSort.sort((a, b) => 
              a.channel.toLowerCase().localeCompare(b.channel.toLowerCase())
            );
            break;
          case 'client':
            sortedChannelsList = channelsToSort.sort((a, b) => {
              const clientA = (a.client || 'No Client').toLowerCase();
              const clientB = (b.client || 'No Client').toLowerCase();
              return clientA === clientB 
                ? a.channel.toLowerCase().localeCompare(b.channel.toLowerCase())
                : clientA.localeCompare(clientB);
            });
            break;
          case 'videos':
            sortedChannelsList = channelsToSort.sort((a, b) => {
              const videosA = a.daily_videos || 0;
              const videosB = b.daily_videos || 0;
              return videosB - videosA; // Descending order
            });
            break;
          default:
            sortedChannelsList = channelsToSort;
        }
        
        // Create new ordering array
        const newChannelOrder = sortedChannelsList.map((channel, index) => ({
          channel_id: channel.id,
          order_position: index
        }));
        
        // Remove existing order and insert new one
        await supabaseClient.from('channel_order').delete().gt('id', 0);
        
        if (newChannelOrder.length > 0) {
          const { error: insertError } = await supabaseClient
            .from('channel_order')
            .insert(newChannelOrder);
          
          if (insertError) throw insertError;
        }
        
        loadAllChannels();
        
        const sortLabels = {
          'collaborator': 'Collaborator',
          'channel': 'Channel Name', 
          'client': 'Client',
          'videos': 'Videos per Month'
        };
        
        showSuccessMessage(`Channels successfully reordered by ${sortLabels[sortCriteria]}!`);

      } catch (error) {
        console.error('Channel reordering error:', error);
        updateConnectionStatus('🔴 Reorder Failed', '#dc3545');
        showErrorMessage('Failed to reorder channels');
      }
    };

    window.hideSuccessModal = function() {
      document.getElementById('successModal').classList.remove('active');
    };

    // Start the Application
    startApplication();
  </script>
</body>
</html>save-button" onclick="saveChannelChanges('${channel.id}')">Save</button>
                    <button class="cancel-button" onclick="cancelChannelEdit()">Cancel</button>
                  </div>
                ` : `
                  <button class="action-button edit-button" onclick="startChannelEdit('${channel.id}')" title="Edit Channel">✏️</button>
                  <button class="action-button complete-button ${channel.status === 'completed' ? 'completed' : ''}" 
                          onclick="toggleTaskStatus('${channel.id}')">
                    ${channel.status === 'completed' ? 'Completed' : 'Complete'}
                  </button>
                  <button class="
